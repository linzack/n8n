# This workflow is used to build and push the Docker image for n8nio/n8n and n8nio/runners
# It has been modified to only push to the forked repository's GitHub Container Registry (GHCR).
# All self-hosted runners have been replaced with GitHub-hosted 'ubuntu-latest' runners.

name: 'Docker: Build and Push (Fork)'

env:
  NODE_OPTIONS: '--max-old-space-size=7168'
  NODE_VERSION: '22.21.0'

on:
  workflow_dispatch:
    inputs:
      n8n_version:
        description: 'N8N version tag to build (e.g., my-fix, latest)'
        required: true
        type: string
        default: 'latest'
      push_enabled:
        description: 'Push image to your fork GHCR'
        required: false
        type: boolean
        default: true

jobs:
  determine-build-context:
    name: Determine Build Context
    runs-on: ubuntu-latest
    outputs:
      n8n_version: ${{ steps.context.outputs.n8n_version }}
      push_enabled: ${{ steps.context.outputs.push_enabled }}
      build_matrix: ${{ steps.matrix.outputs.matrix }}
    steps:
      - name: Determine build context values
        id: context
        run: |
          echo "n8n_version=${{ inputs.n8n_version }}" >> "$GITHUB_OUTPUT"
          echo "push_enabled=${{ inputs.push_enabled }}" >> "$GITHUB_OUTPUT"

      - name: Determine build matrix
        id: matrix
        run: |
          MATRIX='{
            "platform": ["amd64", "arm64"],
            "include": [{
              "platform": "amd64",
              "runner": "ubuntu-latest",
              "docker_platform": "linux/amd64"
            }, {
              "platform": "arm64",
              "runner": "ubuntu-latest",
              "docker_platform": "linux/arm64"
            }]
          }'
          echo "matrix=$(echo "$MATRIX" | jq -c .)" >> "$GITHUB_OUTPUT"
          echo "Build matrix: $(echo "$MATRIX" | jq .)"

  build-and-push-docker:
    name: Build and Push Docker Image (${{ matrix.platform }})
    needs: determine-build-context
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix: ${{ fromJSON(needs.determine-build-context.outputs.build_matrix) }}
    outputs:
      primary_ghcr_manifest_tag: ${{ steps.determine-tags.outputs.primary_ghcr_manifest_tag }}
      runners_primary_ghcr_manifest_tag: ${{ steps.determine-runners-tags.outputs.primary_ghcr_manifest_tag }}
      runners_distroless_primary_ghcr_manifest_tag: ${{ steps.determine-runners-tags.outputs.primary_ghcr_manifest_tag_distroless }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js with pnpm caching
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build n8n application
        run: pnpm build:n8n

      - name: Verify 'compiled' directory contents
        run: |
          echo "Checking 'compiled' directory at root:"
          ls -la ./compiled
          echo "Checking 'packages/frontend/editor-ui/dist' for built frontend assets:"
          ls -la ./packages/frontend/editor-ui/dist || echo "Frontend dist directory not found."
        shell: bash

      - name: Copy frontend assets to compiled directory
        run: |
          mkdir -p ./compiled/dist/public
          cp -r ./packages/frontend/editor-ui/dist/* ./compiled/dist/public/
          echo "Frontend assets copied to compiled/dist/public"
          ls -la ./compiled/dist/public

      - name: Determine Docker tags
        id: determine-tags
        run: |
          N8N_VERSION_TAG="${{ needs.determine-build-context.outputs.n8n_version }}"
          GHCR_BASE="ghcr.io/${{ github.repository }}"
          PLATFORM="${{ matrix.platform }}"

          PRIMARY_GHCR_MANIFEST_TAG_VALUE="${GHCR_BASE}:${N8N_VERSION_TAG}"
          GHCR_TAGS_FOR_PUSH="${PRIMARY_GHCR_MANIFEST_TAG_VALUE}-${PLATFORM}"

          echo "Generated Tags for push: $GHCR_TAGS_FOR_PUSH"
          {
            echo "tags<<EOF"
            echo -e "$GHCR_TAGS_FOR_PUSH"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

          if [[ "$PLATFORM" == "amd64" ]]; then
            echo "primary_ghcr_manifest_tag=${PRIMARY_GHCR_MANIFEST_TAG_VALUE}" >> "$GITHUB_OUTPUT"
          fi

      - name: Determine Docker tags (runners variants)
        id: determine-runners-tags
        run: |
          # Call the script with an empty string for Docker Hub base
          .github/scripts/determine-runners-tags.sh \
            "dev" \
            "${{ needs.determine-build-context.outputs.n8n_version }}" \
            "ghcr.io/${{ github.repository }}/runners" \
            "" \
            "${{ matrix.platform }}" \
            "$GITHUB_OUTPUT"

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        if: needs.determine-build-context.outputs.push_enabled == 'true'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push n8n Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/images/n8n/Dockerfile
          build-args: |
            NODE_VERSION=${{ env.NODE_VERSION }}
            N8N_VERSION=${{ needs.determine-build-context.outputs.n8n_version }}
            N8N_RELEASE_TYPE=dev
          platforms: ${{ matrix.docker_platform }}
          provenance: true
          sbom: true
          push: ${{ needs.determine-build-context.outputs.push_enabled }}
          tags: ${{ steps.determine-tags.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push task runners Docker image (Alpine)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/images/runners/Dockerfile
          build-args: |
            NODE_VERSION=${{ env.NODE_VERSION }}
            N8N_VERSION=${{ needs.determine-build-context.outputs.n8n_version }}
            N8N_RELEASE_TYPE=dev
          platforms: ${{ matrix.docker_platform }}
          provenance: true
          sbom: true
          push: ${{ needs.determine-build-context.outputs.push_enabled }}
          tags: ${{ steps.determine-runners-tags.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push task runners Docker image (distroless)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/images/runners/Dockerfile.distroless
          build-args: |
            NODE_VERSION=${{ env.NODE_VERSION }}
            N8N_VERSION=${{ needs.determine-build-context.outputs.n8n_version }}
            N8N_RELEASE_TYPE=dev
          platforms: ${{ matrix.docker_platform }}
          provenance: true
          sbom: true
          push: ${{ needs.determine-build-context.outputs.push_enabled }}
          tags: ${{ steps.determine-runners-tags.outputs.tags_distroless }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  create_multi_arch_manifest:
    name: Create Multi-Arch Manifest
    needs: [determine-build-context, build-and-push-docker]
    runs-on: ubuntu-latest
    if: |
      needs.build-and-push-docker.result == 'success' &&
      needs.determine-build-context.outputs.push_enabled == 'true'
    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3.11.1

      - name: Login to GitHub Container Registry
        uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772 # v3.4.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GHCR multi-arch manifest
        if: needs.build-and-push-docker.outputs.primary_ghcr_manifest_tag != ''
        run: |
          MANIFEST_TAG="${{ needs.build-and-push-docker.outputs.primary_ghcr_manifest_tag }}"
          echo "Creating GHCR manifest: $MANIFEST_TAG"
          docker buildx imagetools create \
            --tag $MANIFEST_TAG \
            ${MANIFEST_TAG}-amd64 \
            ${MANIFEST_TAG}-arm64

      - name: Create GHCR multi-arch manifest for runners (Alpine)
        if: needs.build-and-push-docker.outputs.runners_primary_ghcr_manifest_tag != ''
        run: |
          MANIFEST_TAG="${{ needs.build-and-push-docker.outputs.runners_primary_ghcr_manifest_tag }}"
          echo "Creating GHCR runners manifest: $MANIFEST_TAG"
          docker buildx imagetools create \
            --tag $MANIFEST_TAG \
            ${MANIFEST_TAG}-amd64 \
            ${MANIFEST_TAG}-arm64

      - name: Create GHCR multi-arch manifest for runners (distroless)
        if: needs.build-and-push-docker.outputs.runners_distroless_primary_ghcr_manifest_tag != ''
        run: |
          MANIFEST_TAG="${{ needs.build-and-push-docker.outputs.runners_distroless_primary_ghcr_manifest_tag }}"
          echo "Creating GHCR runners distroless manifest: $MANIFEST_TAG"
          docker buildx imagetools create \
            --tag $MANIFEST_TAG \
            ${MANIFEST_TAG}-amd64 \
            ${MANIFEST_TAG}-arm64
